{% extends 'base_template.html' %}
{% block content %}
<div class="home">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="mb-0">Elementos Audiovisuales</h1>
    {% if elementos %}
      <span class="text-muted">Mostrando {{ elementos|length }} resultado{% if elementos|length != 1 %}s{% endif %}</span>
    {% endif %}
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form method="get" action="{{ url_for('listar_elementos') }}" class="filters">
        <div class="row g-3 align-items-end">
          <div class="col-sm-6 col-md-4">
            <label for="placa" class="form-label">Buscar por placa</label>
            <input type="text" id="placa" name="placa" value="{{ placa }}" placeholder="Ej: CAM001, MIC001" class="form-control" />
          </div>
          <div class="col-sm-6 col-md-4">
            <label for="tipo" class="form-label">Filtrar por tipo</label>
            <select id="tipo" name="tipo" class="form-select">
              <option value="">Todos</option>
              {% for t in tipos %}
                <option value="{{ t }}" {% if t == tipo %}selected{% endif %}>{{ t|capitalize }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Aplicar filtros</button>
            <a href="{{ url_for('listar_elementos') }}" class="btn btn-outline-secondary">Limpiar</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if elementos|length == 0 %}
    <div class="alert alert-info">No se encontraron elementos con los filtros aplicados.</div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Placa</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for e in elementos %}
            <tr>
              <td class="text-nowrap">{{ e.placa }}</td>
              <td><a href="{{ url_for('ver_elemento_slug', slug=e.slug) }}">{{ e.nombre }}</a></td>
              <td>{{ e.tipo|capitalize }}</td>
              <td>
                <span class="badge {% if e.disponible %}bg-success{% else %}bg-secondary{% endif %}">
                  {% if e.disponible %}Disponible{% else %}Prestado{% endif %}
                </span>
              </td>
              <td class="text-end">
                {% if e.disponible %}
                  <a href="{{ url_for('solicitar_prestamo', elemento_id=e.id) }}" class="btn btn-primary btn-sm">Solicitar préstamo</a>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
                {% if current_user.is_authenticated and (current_user.es_admin or e.user_id == current_user.id) %}
                  <form action="{{ url_for('eliminar_elemento', id=e.id) }}" method="post" class="d-inline" onsubmit="return confirm('¿Eliminar el elemento {{ e.nombre }}? Esta acción no se puede deshacer.');">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Eliminar</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}